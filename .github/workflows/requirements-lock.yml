name: Requirements Lock (pip-tools)

on:
  workflow_dispatch: {}
  pull_request:
    paths:
      - "requirements.in"
      - "requirements/*.in"

jobs:
  lock:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install pip-tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools
      - name: Compile requirements with hashes
        run: |
          pip-compile --generate-hashes --output-file requirements.txt requirements.in
      - name: Show diff
        run: |
          if git diff --exit-code requirements.txt; then
            echo "No changes in locked requirements."; else echo "Locked requirements changed."; fi
      - name: Upload locked requirements artifact
        uses: actions/upload-artifact@v4
        with:
          name: locked-requirements
          path: requirements.txt
      - name: Fail if diff (require commit)
        run: |
          git diff --exit-code requirements.txt || { echo 'Commit updated requirements.txt with hashes.'; exit 1; }
